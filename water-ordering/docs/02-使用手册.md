# 使用手册

## 快速开始

### 1. 环境准备

#### 1.1 安装Python依赖
```bash
cd backend
pip install -r requirements.txt
```

#### 1.2 配置数据库
编辑 `backend/config/config.yaml`：
```yaml
database_url: "mysql+pymysql://用户名:密码@localhost:3306/water_ordering?charset=utf8mb4"
environment: "dev"  # dev开发环境, prod生产环境
code_expire_minutes: 5  # 验证码有效期
```

#### 1.3 初始化数据库

**方式1：一键初始化（推荐）**
```bash
# 在Navicat或MySQL客户端中执行
mysql -u用户名 -p < backend/database/complete_init.sql
```
包含：数据库、表结构、测试数据、管理员账号(admin/admin123)

**方式2：分步初始化**
```bash
# 创建数据库
mysql -u用户名 -p -e "CREATE DATABASE water_ordering CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 创建表结构
mysql -u用户名 -p < backend/database/init.sql

# 创建管理员（需要Python环境）
cd backend && python scripts/init_admin_user.py

# 添加测试数据（可选）
python scripts/init_data.py
```

#### 1.4 安装Web端依赖
```bash
cd web-admin
npm install
```

### 2. 启动服务

**启动后端**
```bash
cd backend
python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**启动Web后台**
```bash
cd web-admin
npm run dev
```

**启动小程序**
1. 打开微信开发者工具
2. 导入项目：选择 `miniprogram` 目录
3. 关闭域名校验（开发环境）：详情 → 本地设置 → 勾选"不校验合法域名..."

### 3. 访问地址

- 后端API: http://localhost:8000
- API文档: http://localhost:8000/docs
- 健康检查: http://localhost:8000/health
- Web后台: http://localhost:5173

## 功能使用

### 小程序端

#### 浏览商品（无需登录）
- 打开小程序查看商品列表
- 点击商品查看详情

#### 登录
1. 需要登录时自动跳转到登录页
2. 输入手机号（11位）
3. 点击"发送验证码"
4. **开发环境**：查看后端控制台获取验证码
5. 输入验证码并登录

#### 购物下单
1. 立即购买 或 加入购物车 → 结算
2. 选择收货地址（首次需添加）
3. 确认订单信息并提交
4. 查看订单详情

### Web后台

#### 登录
- 地址: http://localhost:5173
- 默认账号: admin / admin123
- **首次登录后请立即修改密码**

#### 商品管理
- 新增商品：点击"新增商品"按钮
- 编辑商品：点击商品卡片的"编辑"按钮
- 上下架：点击"上架"/"下架"按钮
- 更新库存：点击"库存"按钮
- 删除商品：点击"删除"按钮

#### 订单管理
- 查看订单：点击顶部导航"订单管理"
- 查看详情：点击订单卡片查看详细信息

## 常用命令

### 数据库操作
```bash
# 添加测试数据
python scripts/init_data.py

# 清空测试数据
python scripts/init_data.py --clear

# 创建管理员
python scripts/init_admin_user.py --username admin --password your_password
```

### 端口管理
```bash
# 查看端口占用
lsof -ti:8000

# 杀掉进程
kill -9 $(lsof -ti:8000)
```

## 故障排查

### 后端无法启动
- 检查端口8000是否被占用
- 检查数据库连接配置
- 验证Python依赖完整性

### 数据库连接失败
- 确认MySQL服务运行
- 检查数据库是否创建
- 验证用户名密码正确

### 验证码获取（开发环境）
- 查看后端控制台输出
- 格式：`[开发环境] 手机号 13800138000 的验证码: 123456`

### Web端无法连接
- 确认后端服务已启动
- 检查浏览器控制台错误
- 验证CORS配置

### 小程序无法连接
- 确认后端服务已启动
- 检查 `app.js` 中的 `apiBaseUrl` 配置
- 确认已关闭域名校验（开发环境）

### 订单创建失败
- 确保用户已通过手机号验证码登录
- 检查用户的 `phone_verified` 字段为 `true`

### 数据库字段错误
如遇字段缺失，执行修复：
```bash
mysql -u用户名 -p < backend/database/fix_phone_verified.sql
```

## 开发环境 vs 生产环境

### 开发环境 (dev)
- 验证码自动返回并打印到控制台
- CORS允许所有来源
- 详细日志输出

### 生产环境 (prod)
- 验证码通过短信服务发送（待集成）
- CORS配置具体域名
- 使用强密钥
