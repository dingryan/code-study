# 使用手册

## 快速开始

### 1. 环境准备

#### 1.1 安装Python依赖
```bash
cd water-ordering/backend
pip install -r requirements.txt
```

#### 1.2 配置数据库
编辑 `backend/config/config.yaml`：
```yaml
database_url: "mysql+pymysql://用户名:密码@localhost:3306/water_ordering?charset=utf8mb4"
environment: "dev"  # dev开发环境, prod生产环境
code_expire_minutes: 5  # 验证码有效期（分钟）
```

#### 1.3 创建数据库
```sql
CREATE DATABASE water_ordering CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 1.4 初始化数据库表

**执行数据库初始化 SQL 文件**

在 MySQL 客户端中执行：
```bash
mysql -u用户名 -p < backend/database/init.sql
```

或者在 MySQL 客户端中：
```sql
source backend/database/init.sql
```

**说明**：
- `backend/database/init.sql` 包含所有表的创建语句
- 包含详细的注释说明
- 按顺序执行，不要跳过任何步骤

#### 1.5 创建初始管理员用户

由于密码需要使用 bcrypt 加密，使用 Python 脚本创建：
```bash
cd water-ordering/backend
python scripts/init_admin_user.py
```

默认创建：用户名 `admin`，密码 `admin123`

或指定用户名和密码：
```bash
python scripts/init_admin_user.py --username admin --password your_password
```

#### 1.6 添加测试数据（可选）

**方法1：使用 Python 脚本**
```bash
python scripts/init_data.py
```

**方法2：执行 SQL 文件**
```bash
mysql -u用户名 -p < backend/database/test_data.sql
```

#### 1.7 修复数据库字段（如需要）

如果遇到字段缺失错误，执行修复脚本：
```bash
mysql -u用户名 -p < backend/database/fix_phone_verified.sql
```

#### 1.6 安装Web端依赖
```bash
cd water-ordering/web-admin
npm install
```

### 2. 启动服务

#### 2.1 启动后端
```bash
cd water-ordering/backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**访问地址：**
- API文档：http://localhost:8000/docs
- 健康检查：http://localhost:8000/health

#### 2.2 启动Web后台
```bash
cd water-ordering/web-admin
npm run dev
```

**访问地址：** http://localhost:5173

#### 2.3 启动小程序
1. 打开微信开发者工具
2. 导入项目：选择 `water-ordering/miniprogram` 目录
3. 配置后端地址：编辑 `app.js` 中的 `apiBaseUrl`
4. 关闭域名校验（开发环境）：详情 → 本地设置 → 勾选"不校验合法域名..."

### 3. 小程序使用

#### 3.1 浏览商品（无需登录）
- 打开小程序首页
- 浏览商品列表
- 点击商品查看详情

#### 3.2 登录
1. 在需要登录的操作时自动跳转到登录页
2. 输入手机号（11位）
3. 点击"发送验证码"
4. **开发环境**：查看后端控制台获取验证码，或查看页面自动回填
5. 输入验证码
6. 点击"登录"

#### 3.3 下单流程
1. 浏览商品 → 选择商品
2. 立即购买 或 加入购物车 → 结算
3. 选择收货地址（如果没有会提示添加）
4. 确认订单信息
5. 提交订单
6. 查看订单详情

### 4. Web后台使用

#### 4.1 登录
1. 打开 http://localhost:5173
2. 输入用户名和密码（默认：admin / admin123）
3. 点击"登录"
4. 如果用户名或密码错误，会显示错误提示，3秒后自动消失

#### 4.2 商品管理
- **查看商品**：登录后自动进入商品管理页面
- **新增商品**：点击"新增商品"按钮
- **编辑商品**：点击商品卡片上的"编辑"按钮
- **上下架**：点击"上架"/"下架"按钮
- **更新库存**：点击"库存"按钮，输入新库存
- **删除商品**：点击"删除"按钮

#### 4.3 订单管理
- **查看订单**：点击顶部导航或访问 `/orders` 路由
- **查看详情**：点击订单卡片查看详情

#### 4.4 修改密码
- **访问修改密码页面**：点击页面右上角的"修改密码"链接
- **输入原密码和新密码**：新密码至少6位
- **确认修改**：修改成功后显示成功提示

### 5. 创建管理员用户

使用脚本创建：
```bash
cd water-ordering/backend
python scripts/init_admin_user.py --username your_username --password your_password
```

## 常见操作

### 数据库操作

```bash
# 初始化数据库表
python scripts/init_db.py

# 添加测试数据
python scripts/init_data.py

# 清空测试数据
python scripts/init_data.py --clear
```

### 验证码获取（开发环境）

**方式1：后端控制台**
- 发送验证码后，查看后端控制台输出
- 格式：`[开发环境] 手机号 18017807956 的验证码: 123456`

**方式2：前端自动回填**
- 开发环境下，验证码会自动回填到输入框

## 故障排查

### 后端无法启动
- 检查端口8000是否被占用
- 检查数据库连接配置
- 检查Python依赖是否安装完整

### 数据库连接失败
- 检查MySQL服务是否运行
- 检查数据库是否创建
- 检查用户名密码是否正确

### 登录失败
- 检查数据库字段是否完整（phone_verified, openid允许NULL）
- 检查验证码是否正确
- 查看后端日志

### Web端无法连接
- 检查后端服务是否启动
- 检查 `.env.development` 中的 `VITE_API_BASE_URL`
- 检查浏览器控制台错误

### 小程序无法连接
- 检查后端服务是否启动
- 检查 `app.js` 中的 `apiBaseUrl`
- 关闭域名校验（开发环境）

