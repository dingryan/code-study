# 数据库文档

## 数据库概述

系统使用 MySQL 数据库，字符集为 `utf8mb4`，排序规则为 `utf8mb4_unicode_ci`。

## 表结构说明

### 1. users - 小程序用户表

小程序端用户信息表，用于存储小程序用户的手机号、微信信息等。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 用户ID | PRIMARY KEY, AUTO_INCREMENT |
| openid | VARCHAR(100) | 微信openid | UNIQUE, NULL |
| nickname | VARCHAR(50) | 昵称 | NULL |
| avatar_url | VARCHAR(500) | 头像URL | NULL |
| phone | VARCHAR(20) | 手机号 | UNIQUE, NULL |
| phone_verified | BOOLEAN | 手机号是否已验证 | DEFAULT FALSE |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE |
| is_active | BOOLEAN | 是否激活 | DEFAULT TRUE |
| is_admin | BOOLEAN | 是否管理员（已废弃，保留字段） | DEFAULT FALSE |

**索引：**
- PRIMARY KEY (id)
- UNIQUE INDEX idx_openid (openid)
- UNIQUE INDEX idx_phone (phone)

**说明：**
- `openid` 可为 NULL（不再使用微信登录）
- `phone` 可为 NULL，但用于登录时必须验证
- `is_admin` 字段已废弃，后台管理员使用独立的 `admin_users` 表

### 2. admin_users - 后台管理员用户表

后台管理系统管理员用户表，与小程序用户完全分离。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 管理员ID | PRIMARY KEY, AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| password_hash | VARCHAR(255) | 密码哈希（bcrypt） | NOT NULL |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | 修改时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE |

**索引：**
- PRIMARY KEY (id)
- UNIQUE INDEX idx_username (username)

**说明：**
- 密码使用 bcrypt 加密存储
- 用户名唯一，用于登录
- 与 `users` 表完全独立

### 3. products - 商品表

商品信息表，存储商品的基本信息。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 商品ID | PRIMARY KEY, AUTO_INCREMENT |
| name | VARCHAR(100) | 商品名称 | NOT NULL |
| description | TEXT | 商品描述 | NULL |
| price | DECIMAL(10,2) | 价格 | NOT NULL |
| image_url | VARCHAR(500) | 图片URL | NULL |
| stock | INT | 库存数量 | DEFAULT 0 |
| is_active | BOOLEAN | 是否上架 | DEFAULT TRUE |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

**索引：**
- PRIMARY KEY (id)

### 4. orders - 订单表

订单主表，存储订单的基本信息。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 订单ID | PRIMARY KEY, AUTO_INCREMENT |
| order_no | VARCHAR(50) | 订单号 | UNIQUE, NOT NULL |
| user_id | INT | 用户ID | FOREIGN KEY -> users.id |
| address_id | INT | 收货地址ID | FOREIGN KEY -> addresses.id |
| total_amount | DECIMAL(10,2) | 订单总金额 | NOT NULL |
| status | VARCHAR(20) | 订单状态 | DEFAULT 'pending' |
| payment_method | VARCHAR(20) | 支付方式 | NULL |
| payment_time | DATETIME | 支付时间 | NULL |
| delivery_time | DATETIME | 送达时间 | NULL |
| remark | TEXT | 备注 | NULL |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE |

**索引：**
- PRIMARY KEY (id)
- UNIQUE INDEX idx_order_no (order_no)
- INDEX idx_user_id (user_id)
- INDEX idx_address_id (address_id)

**订单状态：**
- `pending`: 待支付
- `paid`: 已支付
- `delivered`: 已送达
- `cancelled`: 已取消

### 5. order_items - 订单项表

订单明细表，存储订单中的商品信息。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 订单项ID | PRIMARY KEY, AUTO_INCREMENT |
| order_id | INT | 订单ID | FOREIGN KEY -> orders.id |
| product_id | INT | 商品ID | FOREIGN KEY -> products.id |
| quantity | INT | 数量 | NOT NULL |
| price | DECIMAL(10,2) | 单价 | NOT NULL |

**索引：**
- PRIMARY KEY (id)
- INDEX idx_order_id (order_id)
- INDEX idx_product_id (product_id)

### 6. addresses - 收货地址表

用户收货地址表。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 地址ID | PRIMARY KEY, AUTO_INCREMENT |
| user_id | INT | 用户ID | FOREIGN KEY -> users.id |
| name | VARCHAR(50) | 收货人姓名 | NOT NULL |
| phone | VARCHAR(20) | 收货人电话 | NOT NULL |
| province | VARCHAR(50) | 省份 | NOT NULL |
| city | VARCHAR(50) | 城市 | NOT NULL |
| district | VARCHAR(50) | 区县 | NOT NULL |
| detail | VARCHAR(200) | 详细地址 | NOT NULL |
| is_default | BOOLEAN | 是否默认地址 | DEFAULT FALSE |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE |

**索引：**
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)

## 数据库初始化

### 1. 创建数据库和表

**执行初始化 SQL 文件**（推荐）

在 MySQL 客户端中执行：
```bash
mysql -u用户名 -p < backend/database/init.sql
```

或者在 MySQL 客户端中：
```sql
source backend/database/init.sql
```

**说明**：
- `backend/database/init.sql` 包含所有表的创建语句
- 包含详细的注释说明
- 按顺序执行，不要跳过任何步骤

### 2. 创建初始管理员用户

由于密码需要使用 bcrypt 加密，使用 Python 脚本创建：
```bash
cd water-ordering/backend
python scripts/init_admin_user.py
```

默认创建：用户名 `admin`，密码 `admin123`

或指定用户名和密码：
```bash
python scripts/init_admin_user.py --username admin --password your_password
```

### 3. 添加测试数据（可选）

**方法1：使用 Python 脚本**
```bash
python scripts/init_data.py
```

**方法2：执行 SQL 文件**
```bash
mysql -u用户名 -p < backend/database/test_data.sql
```

## 数据库维护

### 修复字段

如果遇到字段缺失错误，执行修复脚本：

```bash
mysql -u用户名 -p < backend/database/fix_phone_verified.sql
```

或者手动执行 SQL：
```sql
-- 添加 phone_verified 字段（如果缺失）
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS phone_verified BOOLEAN DEFAULT FALSE COMMENT '手机号是否已验证';

-- 修改 openid 允许为 NULL（如果报错）
ALTER TABLE users 
MODIFY COLUMN openid VARCHAR(100) NULL COMMENT '微信 openid（可选）';
```

### 备份和恢复

```bash
# 备份数据库
mysqldump -u用户名 -p密码 water_ordering > backup.sql

# 恢复数据库
mysql -u用户名 -p密码 water_ordering < backup.sql
```

## 表关系图

```
users (小程序用户)
  ├── orders (订单)
  │     └── order_items (订单项)
  │           └── products (商品)
  └── addresses (收货地址)

admin_users (后台管理员) - 独立表，与 users 无关联
```

## 注意事项

1. **用户分离**：`users` 和 `admin_users` 是完全独立的表，互不关联
2. **密码安全**：`admin_users` 表中的密码使用 bcrypt 加密，不可逆
3. **订单关联**：订单只关联 `users` 表，不关联 `admin_users`
4. **索引优化**：已为常用查询字段添加索引，提高查询性能
5. **字符集**：统一使用 `utf8mb4` 支持 emoji 等特殊字符

