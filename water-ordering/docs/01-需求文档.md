# 需求文档

## 项目概述

网上订水系统，包含小程序端（用户下单）和Web后台（管理员管理）。

## 功能需求

### 1. 小程序端（用户）

#### 1.1 登录认证
- **登录方式**：手机号验证码登录（不依赖微信）
- **验证码规则**：
  - 6位数字验证码
  - 有效期5分钟
  - 5分钟内同一手机号返回相同验证码
  - 验证码一次性使用（验证成功后删除）
- **开发环境**：验证码自动返回并回填到输入框
- **生产环境**：需要集成短信服务商（暂未实现）

#### 1.2 权限控制
- **未登录用户**：
  - ✅ 可以浏览商品列表
  - ✅ 可以查看商品详情
  - ❌ 不能加入购物车
  - ❌ 不能立即购买
  - ❌ 不能查看订单
  - ❌ 不能管理地址
- **已登录用户**：
  - ✅ 可以使用所有功能
  - ✅ 必须已验证手机号才能下单

#### 1.3 商品功能
- 浏览商品列表（公开，无需登录）
- 查看商品详情（公开，无需登录）
- 加入购物车（需要登录）
- 立即购买（需要登录）

#### 1.4 购物车功能
- 查看购物车（需要登录）
- 选择/取消选择商品
- 全选/取消全选
- 修改商品数量
- 删除商品
- 结算选中的商品

#### 1.5 订单功能
- 创建订单（需要已验证手机号）
- 查看订单列表（需要登录）
- 查看订单详情（需要登录）
- 取消订单（需要登录）

#### 1.6 地址管理
- 查看地址列表（需要登录）
- 添加地址（需要登录）
- 编辑地址（需要登录）
- 删除地址（需要登录）
- 设置默认地址（需要登录）

### 2. Web后台（管理员）

#### 2.1 登录认证
- 用户名密码登录（不再使用验证码）
- 后台用户与小程序用户完全分离
- 登录失败显示错误提示，3秒后自动消失
- 支持修改密码功能

#### 2.2 商品管理
- 查看所有商品（包括上架和下架的）
- 新增商品
- 编辑商品信息
- 删除商品
- 商品上下架
- 更新商品库存

#### 2.3 订单管理
- 查看所有订单
- 查看订单详情（包含商品信息、收货地址等）

### 3. 后端API

#### 3.1 响应格式
统一响应格式：
```json
{
  "code": "0",
  "data": {},
  "msg": "操作成功.",
  "requestId": "8df5b689613421bc"
}
```

- `code`: "0" 表示成功
- `data`: 成功时返回数据，失败时返回错误信息
- `msg`: 成功时"操作成功."，失败时返回失败原因
- `requestId`: 请求唯一标识

#### 3.2 权限要求
- **公开接口**：商品列表、商品详情
- **需要登录**：地址管理、订单查询、用户信息
- **需要已验证手机号**：创建订单

## 技术架构

### 前端
- **小程序**：微信小程序原生开发
- **Web后台**：React + Vite + React Router

### 后端
- **框架**：FastAPI
- **数据库**：MySQL
- **ORM**：SQLAlchemy
- **认证**：JWT

### 部署
- **后端**：Python FastAPI服务
- **Web后台**：独立前端应用
- **小程序**：微信小程序平台

## 数据库要求

### 用户表

#### 小程序用户表（users）
- `openid`: 可为NULL（不再使用微信登录）
- `phone`: 唯一索引，可为NULL
- `phone_verified`: 是否已验证手机号（默认false）
- `is_admin`: 已废弃，保留字段（不再使用）

#### 后台管理员表（admin_users）
- `username`: 用户名（唯一，用于登录）
- `password_hash`: 密码哈希（bcrypt加密）
- `created_at`: 创建时间
- `updated_at`: 修改时间

## 环境配置

### 开发环境（dev）
- 验证码自动返回
- 后端控制台打印验证码
- CORS允许所有来源

### 生产环境（prod）
- 验证码通过短信服务商发送（待实现）
- CORS配置具体域名
- 使用强密钥

## 非功能需求

1. **性能**：接口响应时间 < 500ms
2. **安全性**：JWT token有效期30分钟
3. **可用性**：验证码有效期5分钟
4. **兼容性**：支持主流浏览器和微信版本

