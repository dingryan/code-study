# 网上订水系统 - 完整使用手册

## 📋 目录

1. [项目概述](#项目概述)
2. [项目结构](#项目结构)
3. [环境准备](#环境准备)
4. [启动服务](#启动服务)
5. [小程序使用](#小程序使用)
6. [Web后台管理](#web后台管理)
7. [API接口使用](#api接口使用)
8. [数据库操作](#数据库操作)
9. [常见操作流程](#常见操作流程)
10. [故障排查](#故障排查)

---

## 项目概述

这是一个完整的网上订水系统，包含：

- **后端服务**：Python FastAPI + MySQL
- **小程序端**：微信小程序（用户下单）
- **Web后台**：React + Vite（管理员后台）

### 主要功能

**小程序端（用户）：**
- ✅ 浏览商品（无需登录）
- ✅ 手机号验证码登录
- ✅ 加入购物车
- ✅ 立即购买
- ✅ 订单管理
- ✅ 收货地址管理

**Web后台（管理员）：**
- ✅ 商品管理（增删改查）
- ✅ 商品上下架
- ✅ 库存管理
- ✅ 订单查看

---

## 项目结构

```
water-ordering/
├── backend/                 # 后端服务
│   ├── app/                 # 应用主目录
│   │   ├── api/             # API路由
│   │   ├── models/          # 数据模型
│   │   ├── schemas/          # 数据验证
│   │   ├── services/         # 业务逻辑
│   │   └── utils/           # 工具函数
│   ├── config/              # 配置文件
│   │   └── config.yaml      # 主配置文件
│   ├── scripts/             # 脚本工具
│   │   ├── init_db.py       # 初始化数据库
│   │   └── init_data.py     # 初始化测试数据
│   └── requirements.txt     # Python依赖
│
├── miniprogram/             # 微信小程序
│   ├── pages/               # 页面
│   │   ├── index/           # 首页
│   │   ├── product/         # 商品详情
│   │   ├── cart/            # 购物车
│   │   ├── checkout/        # 结算页
│   │   ├── order/           # 订单列表
│   │   ├── order-detail/    # 订单详情
│   │   ├── address/         # 地址管理
│   │   └── login/           # 登录页
│   ├── utils/               # 工具函数
│   └── app.js               # 小程序入口
│
└── web-admin/                # Web后台管理
    ├── src/
    │   ├── pages/            # 页面
    │   │   ├── Login.jsx     # 登录页
    │   │   ├── Products.jsx  # 商品管理
    │   │   └── Orders.jsx   # 订单管理
    │   └── utils/           # 工具函数
    └── package.json
```

---

## 环境准备

### 1. 安装Python依赖

```bash
cd water-ordering/backend
pip install -r requirements.txt
```

### 2. 配置数据库

编辑 `backend/config/config.yaml`：

```yaml
database_url: "mysql+pymysql://用户名:密码@localhost:3306/water_ordering?charset=utf8mb4"
environment: "dev"  # dev开发环境, prod生产环境
```

### 3. 创建数据库

在MySQL中执行：

```sql
CREATE DATABASE water_ordering CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 4. 初始化数据库表

```bash
cd water-ordering/backend
python scripts/init_db.py
```

### 5. 添加测试数据

```bash
python scripts/init_data.py
```

### 6. 安装Web端依赖

```bash
cd water-ordering/web-admin
npm install
```

---

## 启动服务

### 1. 启动后端服务

```bash
cd water-ordering/backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**访问地址：**
- API文档：http://localhost:8000/docs
- 健康检查：http://localhost:8000/health
- API基础URL：http://localhost:8000

### 2. 启动Web后台

```bash
cd water-ordering/web-admin
npm run dev
```

**访问地址：**
- Web后台：http://localhost:5173

### 3. 启动小程序

1. 打开微信开发者工具
2. 选择"导入项目"
3. 选择 `water-ordering/miniprogram` 目录
4. 填写AppID（测试号或正式AppID）
5. 点击"编译"

**配置后端地址：**

编辑 `miniprogram/app.js`：

```javascript
globalData: {
  apiBaseUrl: 'http://localhost:8000'  // 开发环境
}
```

**关闭域名校验（开发环境）：**
1. 点击右上角"详情"
2. 在"本地设置"中勾选"不校验合法域名..."
3. 重新编译

---

## 小程序使用

### 用户功能

#### 1. 浏览商品（无需登录）

- **首页**：显示所有上架商品
- **商品详情**：点击商品查看详细信息
- **功能**：可以查看商品图片、价格、库存、描述

#### 2. 登录

**登录流程：**
1. 在需要登录的操作时（如加入购物车、下单），会自动跳转到登录页
2. 输入手机号（11位）
3. 点击"发送验证码"
4. **开发环境**：查看后端控制台获取验证码，或查看页面提示
5. 输入6位验证码
6. 点击"登录"

**登录后：**
- 可以加入购物车
- 可以立即购买
- 可以查看订单
- 可以管理地址

#### 3. 加入购物车

1. 在商品详情页
2. 选择数量
3. 点击"加入购物车"
4. 提示"已加入购物车"

#### 4. 购物车管理

**功能：**
- 查看购物车商品
- 选择/取消选择商品
- 全选/取消全选
- 修改商品数量
- 删除商品
- 结算选中的商品

**操作：**
- 点击商品可以进入商品详情
- 点击"结算"跳转到结算页

#### 5. 立即购买

1. 在商品详情页
2. 选择数量
3. 点击"立即购买"
4. 如果没有地址，会提示添加地址
5. 跳转到订单详情页

#### 6. 结算下单

1. 在购物车选择商品，点击"结算"
2. 或直接"立即购买"
3. 选择收货地址（如果没有会提示添加）
4. 确认订单信息
5. 点击"提交订单"
6. 跳转到订单详情页

#### 7. 订单管理

**订单列表：**
- 显示所有订单
- 显示订单状态（待支付、已支付、已送达、已取消）
- 点击订单查看详情

**订单详情：**
- 订单号
- 订单状态
- 商品列表
- 收货地址
- 订单金额
- 创建时间

#### 8. 地址管理

**添加地址：**
1. 进入"我的" → "收货地址"
2. 点击"添加地址"
3. 填写信息：
   - 收货人姓名
   - 手机号
   - 省市区
   - 详细地址
   - 设为默认地址（可选）
4. 保存

**编辑地址：**
- 点击地址进入编辑页
- 修改信息后保存

**删除地址：**
- 在地址列表页点击删除
- 确认删除

**设置默认地址：**
- 编辑地址时勾选"设为默认"
- 或添加新地址时勾选

---

## Web后台管理

### 访问地址

http://localhost:5173

### 登录

1. 打开Web后台
2. 输入管理员手机号
3. 点击"发送验证码"
4. **开发环境**：查看后端控制台或页面提示获取验证码
5. 输入验证码
6. 点击"登录"

**注意：**
- 只有管理员账号（`is_admin=true`）才能登录
- 非管理员会提示"您不是管理员，无法访问后台"

### 商品管理

#### 查看商品列表

- 登录后自动进入商品管理页面
- 显示所有商品（包括上架和下架的）

#### 新增商品

1. 点击"新增商品"按钮
2. 填写商品信息：
   - 商品名称（必填）
   - 描述（可选）
   - 价格（必填）
   - 库存（必填）
   - 图片URL（可选）
   - 是否上架（默认勾选）
3. 点击"保存"

#### 编辑商品

1. 在商品列表中点击"编辑"按钮
2. 修改商品信息
3. 点击"保存"

#### 上下架商品

1. 在商品列表中点击"上架"或"下架"按钮
2. 商品状态立即更新

#### 更新库存

1. 在商品列表中点击"库存"按钮
2. 输入新的库存数量
3. 点击确定

#### 删除商品

1. 在商品列表中点击"删除"按钮
2. 确认删除
3. **注意：**删除操作不可恢复

### 订单管理

#### 查看订单列表

1. 点击顶部导航或访问 `/orders` 路由
2. 显示所有订单
3. 显示订单号、状态、商品数量、总金额、创建时间

#### 查看订单详情

1. 点击订单卡片
2. 弹出订单详情对话框
3. 显示：
   - 订单基本信息
   - 收货地址
   - 商品列表
   - 订单金额

---

## API接口使用

### 基础URL

```
http://localhost:8000
```

### 认证接口

#### 1. 发送验证码

```http
POST /api/auth/send-code
Content-Type: application/json

{
  "phone": "13800138000"
}
```

**响应（开发环境）：**
```json
{
  "code": 0,
  "message": "验证码已发送",
  "data": {
    "code": "123456",  // 开发环境返回验证码
    "message": "验证码已发送"
  }
}
```

**响应（生产环境）：**
```json
{
  "code": 0,
  "message": "验证码已发送",
  "data": {
    "message": "验证码已发送"
  }
}
```

#### 2. 手机号登录

```http
POST /api/auth/phone-login
Content-Type: application/json

{
  "phone": "13800138000",
  "code": "123456"
}
```

**响应：**
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "token_type": "bearer",
    "user": {
      "id": 1,
      "phone": "13800138000",
      "nickname": null,
      "phone_verified": true
    }
  }
}
```

### 商品接口

#### 1. 获取商品列表（公开）

```http
GET /api/products/?skip=0&limit=100
```

**响应：**返回所有上架的商品

#### 2. 获取商品详情（公开）

```http
GET /api/products/{product_id}
```

#### 3. 获取所有商品（管理员）

```http
GET /api/products/admin/all
Authorization: Bearer {token}
```

#### 4. 创建商品（管理员）

```http
POST /api/products/
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "矿泉水",
  "description": "500ml装",
  "price": 10.00,
  "stock": 100,
  "image_url": "https://example.com/image.jpg",
  "is_active": true
}
```

#### 5. 更新商品（管理员）

```http
PUT /api/products/{product_id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "矿泉水（更新）",
  "price": 12.00
}
```

#### 6. 删除商品（管理员）

```http
DELETE /api/products/{product_id}
Authorization: Bearer {token}
```

#### 7. 上下架商品（管理员）

```http
PATCH /api/products/{product_id}/toggle
Authorization: Bearer {token}
Content-Type: application/json

{
  "is_active": false
}
```

#### 8. 更新库存（管理员）

```http
PATCH /api/products/{product_id}/stock
Authorization: Bearer {token}
Content-Type: application/json

{
  "stock": 200
}
```

### 订单接口

#### 1. 创建订单（需要已验证手机号）

```http
POST /api/orders/
Authorization: Bearer {token}
Content-Type: application/json

{
  "address_id": 1,
  "items": [
    {
      "product_id": 1,
      "quantity": 2,
      "price": 10.00
    }
  ],
  "remark": "请尽快送达"
}
```

**注意：**用户必须已验证手机号（`phone_verified=true`）

#### 2. 获取订单列表

```http
GET /api/orders/?skip=0&limit=100
Authorization: Bearer {token}
```

#### 3. 获取订单详情

```http
GET /api/orders/{order_id}
Authorization: Bearer {token}
```

#### 4. 取消订单

```http
PUT /api/orders/{order_id}/cancel
Authorization: Bearer {token}
```

### 地址接口

#### 1. 获取地址列表

```http
GET /api/addresses/
Authorization: Bearer {token}
```

#### 2. 创建地址

```http
POST /api/addresses/
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "张三",
  "phone": "13800138000",
  "province": "广东省",
  "city": "深圳市",
  "district": "南山区",
  "detail": "科技园路123号",
  "is_default": true
}
```

#### 3. 更新地址

```http
PUT /api/addresses/{address_id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "李四",
  "detail": "新地址"
}
```

#### 4. 删除地址

```http
DELETE /api/addresses/{address_id}
Authorization: Bearer {token}
```

### 用户接口

#### 1. 获取当前用户信息

```http
GET /api/users/me
Authorization: Bearer {token}
```

#### 2. 更新用户信息

```http
PUT /api/users/me
Authorization: Bearer {token}
Content-Type: application/json

{
  "nickname": "新昵称",
  "avatar_url": "https://example.com/avatar.jpg"
}
```

---

## 数据库操作

### 初始化数据库

```bash
cd water-ordering/backend
python scripts/init_db.py
```

### 添加测试数据

```bash
python scripts/init_data.py
```

### 清空测试数据

```bash
python scripts/init_data.py --clear
```

### 删除所有表（谨慎使用）

```bash
python scripts/init_db.py --drop
```

### 设置管理员

```sql
-- 将用户设置为管理员
UPDATE users SET is_admin = 1 WHERE phone = '13800138000';
```

---

## 常见操作流程

### 流程1：用户首次使用小程序下单

1. 打开小程序
2. 浏览商品（无需登录）
3. 选择商品，点击"立即购买"
4. 自动跳转到登录页
5. 输入手机号，发送验证码
6. 输入验证码登录
7. 如果没有地址，添加收货地址
8. 确认订单信息
9. 提交订单
10. 查看订单详情

### 流程2：管理员管理商品

1. 打开Web后台（http://localhost:5173）
2. 使用管理员账号登录
3. 进入商品管理页面
4. 点击"新增商品"
5. 填写商品信息并保存
6. 商品自动上架
7. 可以编辑、上下架、更新库存、删除

### 流程3：查看订单

**小程序端：**
1. 登录后进入"订单"页面
2. 查看所有订单
3. 点击订单查看详情

**Web后台：**
1. 登录后进入"订单管理"
2. 查看所有订单
3. 点击订单查看详情

---

## 故障排查

### 问题1：后端无法启动

**检查：**
- Python版本（建议3.8+）
- 依赖是否安装完整：`pip install -r requirements.txt`
- 端口8000是否被占用
- 数据库连接配置是否正确

**解决：**
```bash
# 检查端口占用
netstat -ano | findstr :8000

# 重新安装依赖
pip install -r requirements.txt --upgrade
```

### 问题2：数据库连接失败

**检查：**
- MySQL服务是否运行
- 数据库是否创建
- 用户名密码是否正确
- `config.yaml` 中的连接字符串是否正确

**解决：**
```bash
# 测试数据库连接
python -c "from app.database import engine; engine.connect(); print('连接成功')"
```

### 问题3：Web端无法连接后端

**检查：**
- 后端服务是否启动
- `.env.development` 中的 `VITE_API_BASE_URL` 是否正确
- 浏览器控制台是否有CORS错误

**解决：**
- 确认后端运行在 http://localhost:8000
- 检查 `web-admin/.env.development` 配置

### 问题4：小程序无法连接后端

**检查：**
- 后端服务是否启动
- `app.js` 中的 `apiBaseUrl` 是否正确
- 是否关闭了域名校验（开发环境）

**解决：**
1. 在微信开发者工具中关闭域名校验
2. 检查 `app.js` 配置
3. 确认后端服务运行正常

### 问题5：验证码收不到

**开发环境：**
- 查看后端控制台输出
- 验证码会打印在控制台
- API响应中也会返回验证码

**生产环境：**
- 当前暂未集成短信服务商
- 需要后续集成阿里云或腾讯云短信服务

### 问题6：订单创建失败，提示"请先验证手机号"

**原因：**
- 用户未通过手机号验证码登录
- 或用户的 `phone_verified` 字段为 `false`

**解决：**
1. 确保用户通过手机号验证码登录
2. 检查数据库：`SELECT * FROM users WHERE id = {user_id};`
3. 确保 `phone_verified = 1`

### 问题7：Web后台登录提示"不是管理员"

**解决：**
```sql
-- 将用户设置为管理员
UPDATE users SET is_admin = 1 WHERE phone = '你的手机号';
```

### 问题8：商品列表为空

**解决：**
```bash
# 添加测试数据
cd water-ordering/backend
python scripts/init_data.py
```

---

## 配置文件说明

### 后端配置 (`backend/config/config.yaml`)

```yaml
# 应用配置
app_name: "网上订水 API"
debug: true
environment: "dev"  # dev开发环境, prod生产环境

# 数据库配置
database_url: "mysql+pymysql://用户名:密码@localhost:3306/water_ordering?charset=utf8mb4"

# JWT配置
secret_key: "development-secret-key-change-in-production-min-32-chars"
access_token_expire_minutes: 30

# 验证码配置
code_expire_minutes: 5  # 验证码有效期（分钟）

# CORS配置
cors_origins:
  - "*"
```

### Web端配置 (`web-admin/.env.development`)

```env
VITE_API_BASE_URL=http://localhost:8000
```

### 小程序配置 (`miniprogram/app.js`)

```javascript
globalData: {
  apiBaseUrl: 'http://localhost:8000'  // 开发环境
}
```

---

## 开发环境 vs 生产环境

### 开发环境 (dev)

- **验证码**：自动返回，后端控制台打印
- **CORS**：允许所有来源
- **调试**：开启详细日志

### 生产环境 (prod)

- **验证码**：需要集成短信服务商（当前暂未实现）
- **CORS**：建议配置具体域名
- **调试**：关闭详细日志
- **密钥**：使用强密钥

---

## 总结

### 用户端（小程序）
- 浏览商品 → 登录 → 下单 → 查看订单

### 管理端（Web后台）
- 登录 → 管理商品 → 查看订单

### 开发调试
- 后端控制台查看日志
- API文档：http://localhost:8000/docs
- 开发环境验证码在控制台打印

---

**需要帮助？** 查看 `验证指南.md` 获取详细的验证步骤。

