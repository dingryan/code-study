# 业务逻辑说明

## 验证码业务逻辑

### 发送验证码流程

1. **接收请求**：`POST /api/auth/send-code`
2. **验证手机号格式**：11位数字，以1开头
3. **检查已有验证码**：
   - 查询内存中是否有该手机号的验证码
   - 如果存在且未过期（当前时间 < 过期时间），返回相同验证码
   - 如果不存在或已过期，生成新验证码
4. **生成验证码**：6位随机数字（100000-999999）
5. **存储验证码**：
   ```python
   {
     "code": "123456",
     "expires_at": 当前时间 + 5分钟,
     "created_at": 当前时间
   }
   ```
6. **返回验证码**：
   - 开发环境：返回验证码到前端
   - 生产环境：调用短信服务商发送（待实现）

### 验证验证码流程

1. **接收请求**：`POST /api/auth/phone-login`
2. **验证手机号格式**
3. **验证验证码**：
   - 检查该手机号是否有验证码记录
   - 检查验证码是否过期（当前时间 > 过期时间）
   - 检查验证码是否正确
   - 验证成功后删除验证码（一次性使用）
4. **用户处理**：
   - 如果用户不存在：创建新用户，`phone_verified=true`
   - 如果用户存在：更新 `phone_verified=true`
5. **生成JWT token**
6. **返回登录结果**

### 验证码特性

- **有效期**：5分钟（配置在 `config.yaml`）
- **5分钟内相同**：同一手机号5分钟内返回相同验证码
- **一次性使用**：验证成功后立即删除
- **存储方式**：内存字典（服务重启后丢失）

## 订单业务逻辑

### 创建订单流程

1. **权限验证**：用户必须已验证手机号（`phone_verified=true`）
2. **验证收货地址**：
   - 地址必须存在
   - 地址必须属于当前用户
3. **验证商品**：
   - 遍历订单项，验证每个商品：
     - 商品是否存在
     - 商品是否上架（`is_active=true`）
     - 库存是否充足（`stock >= quantity`）
4. **计算订单金额**：
   - 每个订单项：`单价 × 数量`
   - 订单总金额：所有订单项金额之和
5. **创建订单记录**：
   - 生成订单号：`WO + 时间戳(YYYYMMDDHHMMSS) + 6位随机数`
   - 订单状态：`pending`（待支付）
6. **创建订单项记录**：关联商品ID、数量、单价
7. **扣减库存**：每个商品的库存减去购买数量
8. **提交事务**：保存到数据库
9. **返回订单信息**

### 取消订单流程

1. **权限验证**：订单必须属于当前用户
2. **检查订单状态**：只能取消 `pending` 或 `paid` 状态的订单
3. **恢复库存**：遍历订单项，将商品库存加回
4. **更新订单状态**：设置为 `cancelled`
5. **保存到数据库**

### 订单状态

- `pending`：待支付
- `paid`：已支付
- `delivered`：已送达
- `cancelled`：已取消

## 地址业务逻辑

### 设置默认地址

当创建或更新地址时，如果 `is_default=true`：
1. 查询该用户的其他地址
2. 将所有其他地址的 `is_default` 设为 `false`
3. 确保只有一个默认地址

## 商品业务逻辑

### 商品上下架

- **上架**：`is_active=true`，商品在公开接口可见
- **下架**：`is_active=false`，商品在公开接口不可见，但管理员可见

### 库存管理

- **创建订单时**：自动扣减库存
- **取消订单时**：自动恢复库存
- **管理员可手动更新**：通过库存管理接口

## 权限控制逻辑

### 用户权限级别

1. **未登录用户**：
   - 只能访问公开接口（商品列表、商品详情）
   - 不能访问需要登录的接口

2. **已登录用户**：
   - 可以访问需要登录的接口
   - 但创建订单需要 `phone_verified=true`

3. **已验证手机号用户**：
   - 可以使用所有用户功能
   - 可以创建订单

4. **管理员用户**：
   - 可以访问后台管理接口
   - 可以管理商品和查看订单

### 权限检查流程

```python
# 1. 公开接口：无需检查
@router.get("/products/")
async def get_products(...):
    # 直接返回数据
    pass

# 2. 需要登录：检查token
@router.get("/orders/")
async def get_orders(
    current_user: User = Depends(get_current_user)
):
    # 只能查看自己的订单
    pass

# 3. 需要验证手机号：检查phone_verified
@router.post("/orders/")
async def create_order(
    current_user: User = Depends(get_verified_user)
):
    # phone_verified必须为true
    pass

# 4. 需要后台管理员：检查admin_users表
@router.post("/products/")
async def create_product(
    current_admin: AdminUser = Depends(get_admin_user)
):
    # 从admin_users表验证，与users表完全独立
    pass
```

## 数据流转

### 用户下单流程

```
用户浏览商品（公开）
    ↓
用户登录（手机号验证码）
    ↓
用户添加地址（需要登录）
    ↓
用户创建订单（需要已验证手机号）
    ↓
系统验证商品和库存
    ↓
系统扣减库存
    ↓
系统创建订单
    ↓
用户支付订单（模拟）
    ↓
订单状态更新为"paid"
```

### 管理员管理流程

```
管理员登录（用户名密码，admin_users表）
    ↓
管理员管理商品（增删改查、上下架、库存）
    ↓
管理员查看订单（查看所有订单）
    ↓
管理员修改密码（可选）
```

## 后台认证业务逻辑

### 后台登录流程

1. **接收请求**：`POST /api/admin-auth/login`
2. **验证用户名和密码**：
   - 查询 `admin_users` 表中是否存在该用户名
   - 如果不存在，返回"用户名或密码错误"
   - 如果存在，使用 bcrypt 验证密码
   - 如果密码错误，返回"用户名或密码错误"
3. **生成JWT token**：
   - 包含用户ID、用户名、type="admin"
4. **返回登录结果**

### 修改密码流程

1. **接收请求**：`POST /api/admin-auth/change-password`
2. **验证token**：获取当前管理员用户
3. **验证原密码**：使用 bcrypt 验证原密码是否正确
4. **验证新密码**：检查新密码长度（至少6位）
5. **更新密码**：使用 bcrypt 加密新密码并保存
6. **返回成功信息**

### 密码安全

- **加密方式**：使用 bcrypt 算法加密
- **不可逆**：密码哈希不可逆，无法从哈希值还原密码
- **验证方式**：登录时使用 bcrypt 的 verify 方法验证

