# 代码验证指南

## 验证步骤

### 1. 启动后端服务

```bash
cd water-ordering/backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

验证点：
- 服务启动成功，访问 http://localhost:8000/health 应返回 `{"status": "ok"}`
- 访问 http://localhost:8000/docs 可以看到API文档

### 2. 启动Web端后台管理系统

```bash
cd water-ordering/web-admin
npm install  # 如果还没安装依赖
npm run dev
```

验证点：
- 服务启动成功，通常在 http://localhost:5173
- 打开浏览器访问，应该看到登录页面

### 3. 验证后端API

#### 3.1 测试发送验证码（开发环境）

```bash
curl -X POST http://localhost:8000/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000"}'
```

预期结果：
- 返回验证码（开发环境）
- 后端控制台打印验证码信息

#### 3.2 测试手机号登录

```bash
# 先获取验证码（假设返回的验证码是 123456）
curl -X POST http://localhost:8000/api/auth/phone-login \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000", "code": "123456"}'
```

预期结果：
- 返回 access_token 和用户信息
- 用户 phone_verified 为 true

#### 3.3 测试订单创建权限（需要已验证手机号）

```bash
# 使用上面获取的token
curl -X POST http://localhost:8000/api/orders/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "address_id": 1,
    "items": [{"product_id": 1, "quantity": 1, "price": 10.00}]
  }'
```

预期结果：
- 如果用户已验证手机号，创建成功
- 如果未验证，返回 403 错误

### 4. 验证Web端后台管理

#### 4.1 登录测试

1. 打开 http://localhost:5173
2. 输入手机号（如：13800138000）
3. 点击"发送验证码"
4. 查看后端控制台或前端提示获取验证码
5. 输入验证码登录

预期结果：
- 开发环境会显示验证码
- 登录成功后跳转到商品管理页面
- 非管理员用户会提示"您不是管理员，无法访问后台"

#### 4.2 商品管理测试

1. 查看商品列表
2. 点击"新增商品"创建商品
3. 编辑商品信息
4. 测试上下架功能
5. 测试库存更新
6. 测试删除商品

预期结果：
- 所有操作都能正常执行
- 商品列表实时更新

#### 4.3 订单管理测试

1. 查看订单列表
2. 点击订单查看详情
3. 验证订单信息显示正确

预期结果：
- 订单列表正常显示
- 订单详情包含完整信息

### 5. 验证小程序

#### 5.1 未登录用户浏览

1. 打开小程序（确保未登录）
2. 浏览首页商品列表
3. 点击商品查看详情

预期结果：
- ✅ 可以正常浏览商品
- ✅ 可以查看商品详情
- ❌ 不能加入购物车（会跳转到登录页）
- ❌ 不能立即购买（会跳转到登录页）

#### 5.2 登录功能

1. 在需要登录的操作时，会自动跳转到登录页
2. 输入手机号
3. 点击"发送验证码"
4. 查看后端控制台获取验证码
5. 输入验证码登录

预期结果：
- 开发环境显示验证码
- 登录成功后返回上一页
- 可以正常使用需要登录的功能

#### 5.3 登录后功能

1. 加入购物车
2. 查看购物车
3. 结算下单
4. 查看订单列表
5. 管理收货地址

预期结果：
- 所有功能正常使用
- 订单创建成功

#### 5.4 权限控制验证

测试场景：
1. 清除登录状态（删除token）
2. 尝试进入购物车页面
3. 尝试进入订单页面
4. 尝试下单

预期结果：
- 都会跳转到登录页面
- 提示"请先登录"

### 6. 验证环境区分

#### 6.1 开发环境（dev）

在 `backend/config/config.yaml` 中设置：
```yaml
environment: "dev"
```

验证：
- 发送验证码时，后端控制台打印验证码
- API返回中包含验证码字段
- 前端显示验证码

#### 6.2 生产环境（prod）

在 `backend/config/config.yaml` 中设置：
```yaml
environment: "prod"
```

验证：
- 发送验证码时，不返回验证码（后续集成短信服务商后会实际发送）
- API返回中不包含验证码字段

### 7. 验证微信登录已移除

检查以下位置确认微信登录代码已移除：

1. `backend/app/api/auth.py` - 应该只有 `send-code` 和 `phone-login` 接口
2. `backend/app/services/auth_service.py` - 应该没有 `wechat_login` 方法
3. `miniprogram/utils/auth.js` - 应该没有 `wechatLogin` 函数
4. `miniprogram/app.js` - 应该没有微信登录相关代码
5. `miniprogram/pages/admin/` - 目录应该已删除

### 8. 常见问题排查

#### 问题1：Web端无法连接后端

解决：
- 检查后端服务是否启动
- 检查 `web-admin/.env.development` 中的 `VITE_API_BASE_URL` 配置
- 检查CORS配置

#### 问题2：小程序无法连接后端

解决：
- 检查后端服务是否启动
- 检查 `miniprogram/app.js` 中的 `apiBaseUrl` 配置
- 在微信开发者工具中关闭域名校验（开发环境）

#### 问题3：验证码收不到

解决：
- 开发环境：查看后端控制台输出
- 生产环境：需要集成短信服务商（当前暂未实现）

#### 问题4：订单创建失败，提示"请先验证手机号"

解决：
- 确保用户已通过手机号验证码登录
- 检查用户表的 `phone_verified` 字段是否为 `true`

### 9. 完整测试流程

1. **后端启动** → 验证健康检查
2. **Web端启动** → 验证登录页面
3. **发送验证码** → 验证开发环境返回验证码
4. **Web端登录** → 验证管理员登录
5. **商品管理** → 验证CRUD操作
6. **订单管理** → 验证订单查看
7. **小程序启动** → 验证未登录浏览
8. **小程序登录** → 验证手机号登录
9. **小程序下单** → 验证权限控制
10. **环境切换** → 验证dev/prod区别

## 测试检查清单

- [ ] 后端服务正常启动
- [ ] Web端正常启动
- [ ] 开发环境验证码自动返回
- [ ] Web端登录功能正常
- [ ] Web端商品管理功能完整
- [ ] Web端订单管理正常
- [ ] 小程序未登录可以浏览商品
- [ ] 小程序未登录不能下单
- [ ] 小程序登录功能正常
- [ ] 小程序登录后可以下单
- [ ] 微信登录代码已完全移除
- [ ] 小程序admin页面已删除
- [ ] 订单创建需要已验证手机号
- [ ] 环境配置正确区分dev/prod

