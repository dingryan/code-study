# 网上订水小程序 - 使用文档

## 项目概述

这是一个完整的网上订水小程序项目，包含：
- **后端**：Python FastAPI + MySQL
- **前端**：微信小程序原生开发

## 快速开始

### 1. 后端启动

#### 安装依赖
```bash
cd water-ordering/backend
pip install -r requirements.txt
```

#### 配置数据库

编辑 `config/config.yaml`，修改数据库连接信息：
```yaml
database_url: "mysql+pymysql://用户名:密码@localhost:3306/water_ordering?charset=utf8mb4"
```

#### 创建数据库
在 MySQL 中执行：
```sql
CREATE DATABASE water_ordering CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 初始化数据库表
```bash
python scripts/init_db.py
```

#### 添加测试数据
```bash
python scripts/init_data.py
```

#### 启动后端服务
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**访问地址：**
- API 文档：http://localhost:8000/docs
- 健康检查：http://localhost:8000/health

### 2. 小程序启动

#### 打开项目
1. 打开微信开发者工具
2. 选择"导入项目"
3. 选择 `water-ordering/miniprogram` 目录
4. 填写 AppID（测试号或正式 AppID）

#### 配置后端地址
编辑 `app.js`，修改 `apiBaseUrl`：
```javascript
apiBaseUrl: 'http://localhost:8000'  // 开发环境
```

#### 关闭域名校验（开发环境）
1. 点击右上角"详情"
2. 在"本地设置"中勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
3. 点击"编译"重新运行

## 常见问题及解决方案

### 问题 1：数据库连接失败

**错误信息：**
```
Table 'water_ordering.products' doesn't exist
```

**解决方案：**
1. 确认数据库已创建
2. 运行初始化脚本：`python scripts/init_db.py`
3. 检查 `config/config.yaml` 中的数据库连接信息是否正确

**验证数据库连接：**
```bash
python -c "from app.database import engine; from sqlalchemy import text; engine.connect(); print('✅ 连接成功')"
```

### 问题 2：Swagger UI 白屏

**错误信息：**
- `Unable to render this definition`
- `The provided definition does not specify a valid version field`

**解决方案：**
已修复，OpenAPI 版本强制设置为 3.0.2 以兼容 Swagger UI 4.x

**访问文档：**
- Swagger UI：http://localhost:8000/docs
- ReDoc：已禁用（CDN 访问问题）

### 问题 3：小程序无法连接后端

**错误信息：**
```
http://localhost:8000 不在以下 request 合法域名列表中
```

**解决方案：**
1. 在微信开发者工具中关闭域名校验（开发环境）
   - 详情 → 本地设置 → 勾选"不校验合法域名..."
2. 重新编译项目

### 问题 4：商品列表 500 错误

**错误信息：**
```
GET http://localhost:8000/api/products/ 500 (Internal Server Error)
```

**解决方案：**
1. 确认数据库表已创建：`python scripts/init_db.py`
2. 确认有测试数据：`python scripts/init_data.py`
3. 检查后端日志查看具体错误

### 问题 5：微信登录失败

**错误信息：**
```
微信登录失败: invalid appid
```

**解决方案：**
1. 开发环境：已添加模拟登录，无需真实 AppID
2. 生产环境：在 `config/config.yaml` 中配置真实的微信 AppID 和 AppSecret

### 问题 6：图片加载失败

**错误信息：**
```
Failed to load image
net::ERR_NAME_NOT_RESOLVED
```

**解决方案：**
1. 更新数据库中的图片 URL：
   ```sql
   UPDATE products SET image_url = '' WHERE image_url LIKE 'https://via.placeholder.com%';
   ```
2. 或重新初始化数据：`python scripts/init_data.py --clear && python scripts/init_data.py`

### 问题 7：pip 升级提示

**提示信息：**
```
[notice] A new release of pip is available: 25.0.1 -> 25.3
```

**说明：**
这是提示信息，不是错误，可以忽略。如需升级：
```bash
python -m pip install --upgrade pip
```

### 问题 8：Chrome DevTools 404 错误

**日志信息：**
```
GET /.well-known/appspecific/com.chrome.devtools.json HTTP/1.1" 404 Not Found
```

**说明：**
这是 Chrome 开发者工具的正常请求，可以忽略，不影响功能。

## 数据库操作

### 初始化数据库表
```bash
python scripts/init_db.py
```

### 添加测试数据
```bash
python scripts/init_data.py
```

### 清空测试数据
```bash
python scripts/init_data.py --clear
```

### 删除所有表（谨慎使用）
```bash
python scripts/init_db.py --drop
```

## 项目结构

```
water-ordering/
├── backend/                    # Python 后端
│   ├── app/
│   │   ├── main.py            # FastAPI 入口
│   │   ├── config.py          # 配置管理
│   │   ├── database.py        # 数据库连接
│   │   ├── api/               # API 路由
│   │   ├── models/            # 数据模型
│   │   ├── schemas/           # 数据验证
│   │   ├── services/          # 业务逻辑
│   │   └── utils/             # 工具函数
│   ├── config/
│   │   └── config.yaml        # 配置文件
│   ├── scripts/
│   │   ├── init_db.py         # 数据库初始化
│   │   └── init_data.py       # 测试数据初始化
│   └── requirements.txt       # Python 依赖
└── miniprogram/               # 微信小程序
    ├── app.json               # 小程序配置
    ├── app.js                 # 小程序入口
    ├── pages/                 # 页面
    ├── components/            # 组件
    └── utils/                 # 工具函数
```

## API 接口说明

### 认证
- `POST /api/auth/wechat-login` - 微信登录
- `GET /api/auth/me` - 获取当前用户信息

### 用户
- `GET /api/users/me` - 获取用户信息
- `PUT /api/users/me` - 更新用户信息

### 商品
- `GET /api/products/` - 获取商品列表
- `GET /api/products/{product_id}` - 获取商品详情

### 订单
- `POST /api/orders/` - 创建订单
- `GET /api/orders/` - 获取订单列表
- `GET /api/orders/{order_id}` - 获取订单详情
- `PUT /api/orders/{order_id}/cancel` - 取消订单

### 地址
- `GET /api/addresses/` - 获取地址列表
- `POST /api/addresses/` - 创建地址
- `GET /api/addresses/{address_id}` - 获取地址详情
- `PUT /api/addresses/{address_id}` - 更新地址
- `DELETE /api/addresses/{address_id}` - 删除地址

### 支付
- `POST /api/payment/pay` - 支付订单（模拟支付）

## 开发环境配置

### 后端配置（config/config.yaml）

```yaml
# 数据库配置
database_url: "mysql+pymysql://用户名:密码@localhost:3306/water_ordering?charset=utf8mb4"

# JWT 配置
secret_key: "development-secret-key-change-in-production-min-32-chars"
access_token_expire_minutes: 30

# 微信配置（开发环境可使用模拟登录）
wechat_app_id: "your-wechat-app-id"
wechat_app_secret: "your-wechat-app-secret"
```

### 小程序配置（app.js）

```javascript
globalData: {
  apiBaseUrl: 'http://localhost:8000'  // 后端 API 地址
}
```

## 功能特性

- ✅ 微信登录认证（开发环境支持模拟登录）
- ✅ 商品浏览和详情
- ✅ 购物车管理
- ✅ 立即购买（直接创建订单）
- ✅ 订单创建和查询
- ✅ 订单详情和取消
- ✅ 地址管理（增删改查）
- ✅ 模拟支付（开发阶段）

## 测试流程

1. **启动后端服务**
   ```bash
   cd water-ordering/backend
   uvicorn app.main:app --reload
   ```

2. **打开小程序**
   - 在微信开发者工具中编译运行
   - 确保已关闭域名校验

3. **测试功能**
   - 首页浏览商品
   - 查看商品详情
   - 加入购物车
   - 立即购买（需要先添加地址）
   - 查看订单列表
   - 管理收货地址

## 注意事项

1. **数据库配置**：生产环境请修改默认密码和密钥
2. **微信配置**：开发环境使用模拟登录，生产环境需要真实 AppID
3. **支付功能**：当前为模拟支付，生产环境需要集成真实微信支付
4. **图片资源**：测试数据中图片 URL 为空，实际使用时需要配置图片服务器
5. **域名配置**：生产环境需要在微信公众平台配置合法域名

## 故障排查

### 后端无法启动
- 检查端口 8000 是否被占用
- 检查数据库连接配置
- 查看错误日志

### 小程序无法连接后端
- 检查后端服务是否启动
- 检查 `app.js` 中的 `apiBaseUrl` 配置
- 确认已关闭域名校验（开发环境）

### 数据库操作失败
- 检查 MySQL 服务是否运行
- 验证数据库连接信息
- 确认数据库和表已创建

## 更新日志

### 已修复的问题
1. ✅ SQLAlchemy Decimal 导入错误 → 改为使用 Numeric
2. ✅ OpenAPI 版本不兼容 → 强制使用 3.0.2
3. ✅ Swagger UI CDN 访问问题 → 使用国内 CDN
4. ✅ 商品 API 序列化问题 → 手动转换为字典
5. ✅ 图片加载失败 → 使用空 URL 和默认占位图
6. ✅ 立即购买功能 → 直接创建订单而非加入购物车
7. ✅ 微信登录开发模式 → 支持模拟登录

## 技术支持

如遇到其他问题，请检查：
1. 后端服务日志
2. 小程序控制台错误
3. 数据库连接状态
4. 网络连接情况

